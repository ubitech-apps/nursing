<?php

include("library.php");

	$action = isset ($_REQUEST['action']) ? $_REQUEST['action'] : '';
	$org_id = isset ($_REQUEST['org_id']) ? $_REQUEST['org_id'] : '';
	$article_id = isset ($_REQUEST['article_id']) ? $_REQUEST['article_id'] : '0';
	 
	if($action=="send")
	{
		$record = array();
		
		$record['article_category'] = isset ($_REQUEST['article_category']) ? $_REQUEST['article_category'] : '';
		$originalDate= isset ($_REQUEST['publish_date']) ? $_REQUEST['publish_date'] : '';
         // $record['publish_date'] = date("Y-m-d", strtotime($originalDate));
		$record['publish_date'] = date("Y-m-d");
		

		$record['doi'] = isset ($_REQUEST['doi']) ? $_REQUEST['doi'] : '';
		$record['doiurl'] = isset ($_REQUEST['doiurl']) ? $_REQUEST['doiurl'] : '';
		$record['authors'] = isset ($_REQUEST['authors']) ? $_REQUEST['authors'] : '';
	 $record['editors_choice'] = isset ($_REQUEST['editors_choice']) ? $_REQUEST['editors_choice'] : '0';
		$pagesfr = isset ($_REQUEST['pagesfrom']) ? $_REQUEST['pagesfrom'] : 0;
		//$pagest = isset ($_REQUEST['editors_choice']) ? $_REQUEST['editors_choice'] : '';
		// $record['editors_choice'] = isset ($_REQUEST['editors_choice']) ? $_REQUEST['editors_choice'] : '';
		//$record['editors_choice'] = $pagest;
		$record['pages'] = $pagesfr;
		$record['keywords'] = isset ($_REQUEST['keywords']) ? $_REQUEST['keywords'] : '';
		$record['issue_id'] = isset ($_REQUEST['issue_id']) ? $_REQUEST['issue_id'] : '';
		$record['title'] = isset ($_REQUEST['editor1']) ? htmlentities(trim($_REQUEST['editor1'] ), ENT_QUOTES, "UTF-8") : '';
		$record['long_desc']= addslashes(htmlentities(trim(isset ($_REQUEST['editor2']) ? $_REQUEST['editor2'] : ''),ENT_COMPAT, "UTF-8"));
		
		 $record['reference']= addslashes(htmlentities(trim(isset ($_REQUEST['editor3']) ? $_REQUEST['editor3'] : ''),ENT_COMPAT, "UTF-8"));
		 $record['article_cite']= addslashes(htmlentities(trim(isset ($_REQUEST['editor4']) ? $_REQUEST['editor4'] : ''),ENT_COMPAT, "UTF-8"));
		
		
		//$uploads_dir = 'php/upload/';
		if($article_id =="0")
		{
			
			$id=get_max_id('article_id','articles');
			$record['article_id'] = $id;
			
			
			if($_FILES['cover_page']['name']!=""){
				$uploads_dir = 'php/images/';
				 $filename=$id."_images".$_FILES['cover_page']['name'];
				
				move_uploaded_file($_FILES['cover_page']['tmp_name'],$uploads_dir.$filename);
				$source_image =  $uploads_dir.$filename;
				$image_destination = $uploads_dir."min".$filename;
				$compress_images = compressImage($source_image, $image_destination);
				$record['cover_page'] = $filename;
					
			}
			
			if($_FILES['fileurl']['name']!=""){
				    $uploads_dir = '../admin/php/uploads/';
					$filename=$id."_pdf.pdf";
					$record['file_url'] = $filename;
					move_uploaded_file($_FILES['fileurl']['tmp_name'],$uploads_dir.$filename);
			}

			// $nameM = basename($_FILES['material']['name']);
			// $nameMM = 'material/'.$nameM;
			// $typeM = $_FILES['material']['type'];
			// $tmpM = $_FILES['material']['tmp_name'];
			// $sizeM =  $_FILES['material']['size'];
			// move_uploaded_file($tmpM, $nameMM);

			// 	move_uploaded_file($_FILES['material']['tmp_name'], "php/material".$_FILES['material']['name']);

			if($_FILES['material']['name']!=""){
				    $uploads_dir1 = 'php/material/';
					$filename1=$id."_pdf.pdf";
					$record['material'] = $filename1;
					move_uploaded_file($_FILES['material']['tmp_name'],$uploads_dir1.$filename1);
			}
			
			$res=query('update articles set sts_new=0');// set remain all article 0
			$sts = insert("articles",$record);	
			if($sts){
				echo "<script type=\"text/javascript\">alert('Articles has been inserted successfully');
					window.open(\"articles.php\",\"_self\");</script>";
			}	
		}else{
			 $record['article_id'] = isset ($_REQUEST['article_id']) ? $_REQUEST['article_id'] : '0';	
			
			if($_FILES['fileurl']['name']!=""){
				$filename=$record['article_id']."_pdf.pdf";
				$uploads_dir = '../admin/php/uploads/';
					$record['file_url'] = $filename;
					 move_uploaded_file($_FILES['fileurl']['tmp_name'] ,$uploads_dir.$filename);
					
			}
			
			if($_FILES['cover_page']['name']!=""){
				$uploads_dir = 'php/images/';
				 $filename=$record['article_id']."_images".$_FILES['cover_page']['name'];
				  move_uploaded_file($_FILES['cover_page']['tmp_name'],$uploads_dir.$filename);
				 $source_image =  $uploads_dir.$filename;
				 $image_destination = $uploads_dir."min".$filename;
				 $compress_images = compressImage($source_image, $image_destination);
				 $record['cover_page'] = $filename;
				
			}
			
			$sts = update("articles",$record,array ('article_id'=> $record['article_id']));
			
			if($sts){
				
				echo "<script type=\"text/javascript\">alert('Articles has been updated successfully');
					window.open(\"articles.php\",\"_self\");</script>";
			}
		}


///////////////////new pdf///////	
		if($article_id =="0")
		{
			
			$id=get_max_id('article_id','articles');
			$record['article_id'] = $id;
			
			if($_FILES['material']['name']!=""){
				    $uploads_dir = '../admin/php/supplementary_material/';
					$filename1=$id."_pdf.pdf";
					$record['material'] = $filename1;
					move_uploaded_file($_FILES['material']['tmp_name'],$uploads_dir.$filename1);
					//$record['material'] = $filename1;

					
			}
			
			$res=query('update articles set sts_new=0');// set remain all article 0
			// print_r($record);
			// exit;
			$sts = insert("articles",$record);	
			if($sts){
				echo "<script type=\"text/javascript\">alert('Articles has been inserted successfully');
					window.open(\"articles.php\",\"_self\");</script>";
			}	
		}else{
			 $record['article_id'] = isset ($_REQUEST['article_id']) ? $_REQUEST['article_id'] : '0';	
			
			if($_FILES['material']['name']!=""){
				$filename1=$record['article_id']."_pdf.pdf";
				$uploads_dir = '../admin/php/supplementary_material/';
					$record['material'] = $filename1;
					 move_uploaded_file($_FILES['material']['tmp_name'] ,$uploads_dir.$filename1);
					
			}
			
			
			$sts = update("articles",$record,array ('article_id'=> $record['article_id']));
			
			if($sts){
				
				echo "<script type=\"text/javascript\">alert('Articles has been updated successfully');
					window.open(\"articles.php\",\"_self\");</script>";
			}
		}


			
	}
	 $row=array();	
	 $sql ="select * from articles where article_id=$article_id";
	 $dbq =query($sql);	
	 if(getRowCount($dbq)>=1)
	 {
		$row = fetch($dbq);
	 }
	 
	function compressImage($source_image, $compress_image) {
		
					$image_info = getimagesize($source_image);
					if ($image_info['mime'] == 'image/jpeg') {
					$source_image = imagecreatefromjpeg($source_image);
					imagejpeg($source_image, $compress_image, 75);
					} elseif ($image_info['mime'] == 'image/gif') {
					$source_image = imagecreatefromgif($source_image);
					imagegif($source_image, $compress_image, 75);
					} elseif ($image_info['mime'] == 'image/png') {
					$source_image = imagecreatefrompng($source_image);
					imagepng($source_image, $compress_image, 6);
					}
					 $compress_image;
                }
?>
<html>
<head>
<title>JABB</title>
<link rel="stylesheet" type="text/css" href="accountmanager/css/chromestyle3.css" />
<script type="text/javascript" src="accountmanager/js/chrome.js"></script>
	
	<script type="text/javascript">
	function backStep(val)
	{
	
		form = document.getElementById('main');
		form.action="articles.php";
		form.submit();
	}
	function save()
	{
		form = document.getElementById('main');
		var data = CKEDITOR.instances.editor1.getData();

		
		//var nicE = $('#summernote1').summernote('code');
			document.getElementById('title').value=data;
			/*var nicE2 = $('#summernote2').summernote('code');		
			document.getElementById('fulltext').value=nicE2;
			var nicE3 = $('#summernote3').summernote('code');
			document.getElementById('reference').value=nicE3;
			var nicE4 = $('#summernote4').summernote('code');
			document.getElementById('article_abstract').value=nicE4;*/
			
		if (form.elements['title'].value == "")
		{
			alert("Title should not be blank.");
			form.elements['title'].focus();
			return false;
		}
		
		form.elements['action'].value ="send";
		form.submit();
	}
	function check_email(e) 
	{
		ok = "1234567890qwertyuiop[]asdfghjklzxcvbnm.@-_QWERTYUIOPASDFGHJKLZXCVBNM";
		for(i=0; i < e.length ;i++)
		{
			if(ok.indexOf(e.charAt(i))<0)
			{ 
				return (false);
			}	
		} 
		if (document.images) 
		{
			re = /(@.*@)|(\.\.)|(^\.)|(^@)|(@$)|(\.$)|(@\.)/;
			re_two = /^.+\@(\[?)[a-zA-Z0-9\-\.]+\.([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
			if (!e.match(re) && e.match(re_two)) 
			{
				return (-1);		
			} 
		}
	}

	function isDoubleKey(evt)
	{
	
		 var charCode = (evt.which) ? evt.which : event.keyCode;
		 if (charCode == 46)
			 return true;
		 else if (charCode > 31 && (charCode < 48 || charCode > 57))
			return false;
				
		 return true;
	}
	</script>
	
<?php addCSSFiles()?>

</head>
<body>
<?php navigationbar()?>

        <!-- Sidebar -->
       <div class="container-fluid">
		  <div class="row">
			<div class="col-sm-3 col-md-2 sidebar">
			  <?php sidebar(2)?>
			</div>
			<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
				<div class="row">
					<h1 class="page-header pull-left">Article</h1>
					
				</div>
				<div class="row">
        <!-- Page content -->
			<div class="panel panel-primary" >
			  <div class="panel-heading">
				<i class="glyphicon glyphicon-book"></i>
                   <?php if($article_id>0){echo 'Edit';}else{ echo 'Add';}?> Article details
				   <div class="pull-right text-white"><a href="articles.php?article_id=<?php echo $article_id;?>" ><i class="glyphicon glyphicon-arrow-left"></i>&nbsp;&nbsp;</a></div>
			  </div>
			  <div class="panel-body">
			  	
					<div class="row">
			
			  <form  class="form-horizontal" name="main" id="main" enctype="multipart/form-data" method="post"  action="editarticle.php" >
			  <input type="hidden" name="action"  id="action"/>
			  <input type="hidden" name="article_id"  id="article_id" value="<?= $article_id; ?>"/>
			  <input type="hidden" id="title" name="title" />
				<input type="hidden" id="fulltext" name="fulltext"  />
				<input type="hidden" id="reference" name="reference"  />
				<input type="hidden" id="article_abstract" name="article_abstract"  />
			  
			
			<div class="form-group">			 		 
			  <label for="inputEmail3" class="col-sm-2 control-label">Issue Number</label>
			   <div class="col-sm-4">
					<select  class="form-control" name="issue_id" id="issue_id">
						<?php  $issueid =0; if(count($row)>0){ $issueid= $row['issue_id'];} fill_issue( $issueid );?>
						<option value="0" <?php if(count($row)>0){ if($row['issue_id'] == 0){echo 'selected'; } }?>>Online first</option>
					</select>
			   </div>
			</div>
			
			<div class="form-group">			 		 
			  <label for="inputEmail3" class="col-sm-2 control-label">Article Category </label>
			   <div class="col-sm-4">
					<select  class="form-control" name="article_category" id="article_category">
					<?php
     					$article_category=query('select * from category_master');
                       while($row1 = fetch($article_category)){
					?>	
					   <option value="<?php echo $row1['category_id']; ?>" <?php if($row1['category_name'] == $row['article_category']){ echo 'selected'; }?>  ><?php echo $row1['category_name']; ?></option>
						<?php } ?>
					</select>
			   </div>
			</div>
			
			<div class="form-group">		
				 <label for="doi" class="col-sm-2 control-label">DOI</label>
				 <div class="col-sm-4 ">
					<input name="doi" id="doi" class="form-control" value="<?php if(count($row)>0) echo $row['doi']; ?>" />
				 </div>
			</div>
			
			<div class="form-group">		
				 <label for="doi" class="col-sm-2 control-label">DOI URL</label>
				 <div class="col-sm-4 ">
					<input name="doiurl" id="doiurl" class="form-control" value="<?php if(count($row)>0) echo $row['doiurl']; ?>" />
				 </div>
			</div>
			
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Title</label>
				 <div class="col-sm-10">
					<textarea name="editor1" class="form-control ckeditor" id="editor1" rows="10" cols="80">
                <?php if(count($row)>0){ echo html_entity_decode(stripslashes($row['title']));} ?>
            </textarea>
					
				 </div>
			</div>
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Abstract</label>
				 <div class="col-sm-10">
					<textarea name="editor2" class="form-control ckeditor" id="editor2" rows="10" cols="80">
                <?php if(count($row)>0){ echo html_entity_decode(stripslashes($row['long_desc']));} ?>
            </textarea>
					
				 </div>
			</div>
			
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Reference</label>
				 <div class="col-sm-10">
					<textarea name="editor3" class="form-control ckeditor" id="editor3" rows="10" cols="80">
                <?php if(count($row)>0){ echo html_entity_decode(stripslashes($row['reference']));} ?>
            </textarea>
					
				 </div>
			</div>
			
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Cite This Article</label>
				 <div class="col-sm-10">
					<textarea name="editor4" class="form-control ckeditor" id="editor4" rows="10" cols="80">
                <?php if(count($row)>0){ echo html_entity_decode(stripslashes($row['article_cite']));} ?>
            </textarea>
					
				 </div>
			</div>
			
			
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Authors </label>
				 <div class="col-sm-4">
					<textarea class="form-control" rows="4" id="authors" name="authors" ><?php if(count($row)>0){ echo $row['authors'];} ?></textarea>
				 </div>
			</div>
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Keywords</label>
				 <div class="col-sm-4">
					<textarea class="form-control" rows="4" id="keywords" name="keywords" ><?php if(count($row)>0){ echo $row['keywords'];}  ?></textarea>
				 </div>
			</div>
			<div class="form-group" id="hidden_page">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Pages</label>
				 <!--<div class="col-sm-4">
					<input type="text" class="form-control" id="pages" name="pages" value="<?php if(count($row)>0){ echo $row['pages'];}  ?>"/>
				 </div>-->
				  <?php// if(count($row)>0){
					// $pages=explode("-",$row['pages']);
					// $pagesfrom=$pages[0];
					// $pagesto=$pages[1];
					// } ?>
				 <div class="col-sm-4">
					<input type="text" class="form-control" id="pagesfrom" name="pagesfrom" value="<?php if(count($row)>0){ echo $row['pages'];}  ?>" placeholder="From-TO" required/>
				 </div>
				  <!--<div class="col-sm-2">
					<input type="number" class="form-control" id="pagesto" name="pagesto" value="<?php if(count($row)>0){ echo $pagesto;}  ?>" placeholder="To" required/>
				 </div>-->
			</div>
			
			<div class="form-group" id="hidden_date" style="display:none;">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Publish Date</label>
				 <div class="col-sm-4">
					<input type="text"  class="form-control" id="datepicker" name="publish_date" placeholder="Publish Date" value="" />
				 </div>
			</div>
			
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">PDF File</label>
				 <div class="col-sm-4">
					<input type="file" class="form-control" id="fileurl" name="fileurl" />
				 </div>
			</div>
			
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Cover Page</label>
				 <div class="col-sm-4">
					<input type="file" class="form-control" id="cover_page" name="cover_page" />
				 </div>
			</div>
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Supplementary Material</label>
				 <div class="col-sm-4">
					<input type="file" class="form-control" id="material" name="material" />
				 </div>
			</div>
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label"> Editor's Choice</label>
				 <div class="col-sm-4">
					<input type="checkbox"  id="chec" name="editors_choice" value="1" />
				 </div>
	</div>
			
			
			
			<!--<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Full Text</label>
				 <div class="col-sm-10">
					<textarea name="editor3" id="editor3" rows="10" cols="80">
                <?php //if(count($row)>0){ echo html_entity_decode(stripslashes($row['full_text']));} ?>
            </textarea>
					
				 </div>
			</div>
			<div class="form-group">		
				 <label for="inputEmail3" class="col-sm-2 control-label">Reference</label>
				 <div class="col-sm-10">
					<textarea name="editor4" id="editor4" rows="10" cols="80">
                <?php //if(count($row)>0){ echo html_entity_decode(stripslashes($row['article_reference']));} ?>
            </textarea>
					
				 </div>
			</div>-->
		 <div class="col-sm-5 control-label">
		   <input type="button" class="btn btn-primary" value="Save" onclick="save()"/>&nbsp;<input type="button" value="Cancel" class="btn btn-default" onclick="backStep(<?= $article_id;?>)"/>
		</div>		 
		 </form>					
					</div>
				</div>
			</div>
			</div>
        </div>
	</div>
</div>
<?php addJSFiles()?>
<!--<script src="//cdn.ckeditor.com/4.5.10/full/ckeditor.js"></script>-->
 <script src="ckeditor/ckeditor.js" ></script>
    <!-- Custom Theme Scripts -->
 <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>   
	
<link href="summernote_editor/summernote.css" rel="stylesheet">
  <script src="summernote_editor/summernote.js"></script>
  <script>
	
                // Replace the <textarea id="editor1"> with a CKEditor
                // instance, using default configuration.
                // CKEDITOR.replace( 'editor1' );
                // CKEDITOR.replace( 'editor2' );
                // CKEDITOR.replace( 'editor3' );
                // CKEDITOR.replace( 'editor4' );
		$('#issue_id').change(function(){
			if($(this).val() == 0){
			    $('#hidden_page').hide();	
			    $('#hidden_date').show();	
			}else{
				$('#hidden_page').show();
				$('#hidden_date').hide();
			}
		})	

	if($('#issue_id').val() == 0){
	 $('#hidden_page').hide();	
	 $('#hidden_date').show();		
	}else{
	$('#hidden_page').show();
	$('#hidden_date').hide();
	}		
	// js for datepicker start //
	
  $(function() {
    $( "#datepicker" ).datepicker();
  });
  	// js for datepicker end //
   </script>
</body>
</html>